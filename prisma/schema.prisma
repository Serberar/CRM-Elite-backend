generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  administrador @map("administrador")
  verificador   @map("verificador")
  coordinador   @map("coordinador")
  comercial     @map("comercial")
}

model User {
  id                    String    @id @default(uuid())
  firstName             String
  lastName              String
  username              String    @unique
  password              String
  role                  Role      @default(administrador)
  lastLoginAt           DateTime?
  refreshToken          String?
  refreshTokenExpiresAt DateTime?

  // relaciones inversas
  assignments        SaleAssignment[]
  saleHistories      SaleHistory[]
  uploadedRecordings SaleRecording[]
}

model Client {
  id           String   @id @default(uuid())
  firstName    String
  lastName     String
  dni          String
  email        String
  birthday     String
  phones       String[]
  addresses    Json
  bankAccounts String[]
  authorized   String?
  businessName String?
  comments     String[]
  createdAt    DateTime @default(now())
  lastModified DateTime @updatedAt

  sales Sale[]

  @@index([dni])
  @@index([phones(ops: ArrayOps)], type: Gin)
  @@index([createdAt])
}

model Product {
  id          String   @id @default(uuid())
  name        String
  description String?
  sku         String?  @unique
  price       Decimal
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  saleItems SaleItem[]
}

model Sale {
  id       String @id @default(uuid())
  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  statusId String
  status   SaleStatus @relation(fields: [statusId], references: [id])

  totalAmount     Decimal @default(0)
  notes           Json?   // [{message, userId, role, createdAt}]
  metadata        Json?

  // üî• NUEVOS CAMPOS PARA SNAPSHOTS
  clientSnapshot  Json?   // ‚Üê snapshot del cliente editado en el front
  addressSnapshot Json?   // ‚Üê snapshot de la direcci√≥n seleccionada
  comercial       String? // ‚Üê nombre del comercial que hace la venta

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  closedAt  DateTime?

  items       SaleItem[]
  assignments SaleAssignment[]
  histories   SaleHistory[]
  recordings  SaleRecording[]
}

model SaleItem {
  id     String @id @default(uuid())
  saleId String
  sale   Sale   @relation(fields: [saleId], references: [id])

  productId String?
  product   Product? @relation(fields: [productId], references: [id])

  nameSnapshot String
  skuSnapshot  String?
  unitPrice    Decimal
  quantity     Int
  finalPrice   Decimal

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SaleStatus {
  id          String  @id @default(uuid())
  name        String
  order       Int
  color       String?
  isFinal     Boolean @default(false)
  isCancelled Boolean @default(false)

  sales Sale[]
}

model SaleHistory {
  id     String @id @default(uuid())
  saleId String
  sale   Sale   @relation(fields: [saleId], references: [id])

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  action    String
  payload   Json?
  createdAt DateTime @default(now())
}

model SaleAssignment {
  id       String @id @default(uuid())
  saleId   String
  sale     Sale   @relation(fields: [saleId], references: [id])

  userId   String
  user     User   @relation(fields: [userId], references: [id])

  role      String
  createdAt DateTime @default(now())
}

model SaleRecording {
  id           String   @id @default(uuid())
  saleId       String
  sale         Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)

  filename     String   // nombre original del archivo
  storagePath  String   // ruta relativa: records/{saleId}/{uuid}.ext
  mimeType     String   // audio/mpeg, audio/wav, video/mp4, etc.
  size         Int      // tama√±o en bytes

  uploadedById String?
  uploadedBy   User?    @relation(fields: [uploadedById], references: [id])

  createdAt    DateTime @default(now())
}
